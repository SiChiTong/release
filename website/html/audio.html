<!DOCTYPE html>
<html>
<head>
    <title>��д����ʾ��</title>
</head>
<script src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
<body>
    <textarea id="result"></textarea>
	<br>
	<script src="http://blog.faultylabs.com/files/md5.js"></script>	
	<script src="http://webapi.openspeech.cn/socket.io/socket.io.js"></script>
	<script src='http://webapi.openspeech.cn/js/util/zepto.min.js'></script>
	<script src='http://webapi.openspeech.cn/js/util/jwav.min.js'></script>
	<script src='http://webapi.openspeech.cn/fingerprint.js'></script>
	<script src="http://webapi.openspeech.cn/iat.min.js"></script>
	<script type="text/javascript">
        var ros = new ROSLIB.Ros({
            url: 'ws://192.168.0.252:9090'
        });
        ros.on('connection', function () {
            console.log('Connected to websocket server.');
        });

        ros.on('error', function (error) {
            console.log('Error connecting to websocket server: ', error);
        });

        ros.on('close', function () {
            console.log('Connection to websocket server closed.');
        });
	</script>
        <script type="text/javascript">
	    /**
		  * ��ʼ��Session����
		  */
	    var session = new IFlyIatSession({
                                      'url' : 'http://webapi.openspeech.cn/',							
                                      'reconnection'       : true,
									  'reconnectionDelay'  : 30000,
									  'compress' : 'speex',
									  'speex_path' : '../js/speex.js',              //speex.js����·�� 
									  'vad_path' : '../js/vad.js',                  //vad.js����·��
									  'recorder_path' : '../js/recorderWorker.js'    //recordWorker.js����·��
						         });
		
		/**
		  * ����¼������ȡʶ����
		  */
		function start() {
		    /***********************************************************����ǩ�����������ʵ��Ӧ����Ϣ����***************************************************/
		 
		    var appid = "57738c5a";                              //Ӧ��APPID����open.voicecloud.cn�����뼴�ɻ��
		    var timestamp = new Date().toLocaleTimeString();                      //��ǰʱ�������new Date().toLocaleTimeString()
            var expires = 60000;                          //ǩ��ʧЧʱ�䣬��λ:ms����60000		
		    //!!!Ϊ����secretkeyй¶��ǩ���������ô��뽨���ڷ����������
		    var signature = faultylabs.MD5(appid + '&' + timestamp + '&' + expires + '&' + "e62d7a1d31fdf3ed");	
		   /************************************************************����ǩ�����������ʵ��Ӧ����Ϣ����**************************************************/
		    var params = {"grammar_list" : null, "params" : "aue=speex-wb;-1, usr = mkchen, ssm = 1, sub = iat, net_type = wifi, ent =sms16k, rst = plain, auf  = audio/L16;rate=16000, vad_enable = 1, vad_timeout = 5000, vad_speech_tail = 500, caller.appid = " + appid + ",timestamp = " + timestamp + ",expires = " + expires, "signature" : signature};
			
            /* ���ÿ�ʼ¼���ӿڣ�ͨ��function(volume)��function(err, obj)�ص�������ʶ���� */
		    session.start(params, function (volume)
		    {	
                /* ��ȡ��չʾ��ǰ¼������ */			
			    if(volume < 6 && volume > 0)
				    console.log("volume : " + volume);
					
			    /* ��volume���ظ�ֵ��˵����˷�����ʧ��*/
			    if(volume < 0)
				    console.log("��˷�����ʧ��");
		    }, function (err, result)
		    {
			    /* ���ص���errΪ�ջ������Ϊ0����Ự�ɹ�������ȡʶ����������ʾ*/
		        if(err == null || err == undefined || err == 0)
			    {
				    if(result == '' || result == null)
					    document.getElementById('result').innerHTML = "û�л�ȡ��ʶ����";
				    else
					{
					    document.getElementById('result').innerHTML = result;

						    var Audio = new ROSLIB.Topic({
							ros: ros,
							name: '/Audio',
							messageType: '/std_msgs/String'
						    });

						    var Audio_2 = new ROSLIB.Message({
							//header: {
							  //  frame_id: "std_msgs"
							//},
							data: result
						    });
						    Audio.publish(Audio_2);
						
					}
			    /* ���ص���err��Ϊ���Ҵ����벻Ϊ0����Ựʧ�ܣ�����ȡ������ */	
			    } else
			    {
			        document.getElementById('result').innerHTML = 'error code : ' + err + ", error description : " + result;
			    }
		    }, function(message)
			{
				if(message == 'onStop')
				{
					console.log("¼��ֹͣ");
				} else if(message == 'onEnd')
				{
					console.log("�Ự����");
				}
			}, function(data)
			{
				console.log(data);
			});			
			
		};
		
		function stop() {
			session.stop(null);
		};
           
	</script>
	<input type="button" value="¼��" onclick="start();"  />
	<input type="button" value="����" onclick="stop();"  />
        
</body>
</html>
