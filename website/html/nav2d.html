<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    <script type="text/javascript" src="js/easeljs.min.js"></script>
    <script type="text/javascript" src="js/eventemitter2.min.js"></script>
    <script type="text/javascript" src="js/roslib.min.js"></script>
    <script type="text/javascript" src="js/ros2d.js"></script>
    <script type="text/javascript" src="js/nav2d.js"></script>

    <script type="text/javascript">
        /**
         * Setup all GUI elements when the page is loaded.
         */
         // Connect to ROS.
         var ros = new ROSLIB.Ros({
             url: 'ws://' + window.location.hostname + ':9090'
         });

        function init() {
            // Create the main viewer.
            var viewer = new ROS2D.Viewer({
                divID: 'nav',
                width: 800,
                height: 800
            });

            // Setup the nav client.
            var nav = NAV2D.OccupancyGridClientNav({
                ros: ros,
                rootObject: viewer.scene,
                continuous: true,
                withOrientation: true,
                viewer: viewer,
                serverName: '/move_base'
            });

            system_mode.subscribe(function(system_mode_message) {
            	if (system_mode_message.data == "busy") {
            		alert("system busy");
        		}
            	else {
            		mode = system_mode_message.data;
                	change_mode_text();
            	}
            });
        }

        var system_mode = new ROSLIB.Topic({
            ros : ros,
            name : '/system_shell/system_mode',
            messageType : 'std_msgs/String'
        });

        var cmd_string = new ROSLIB.Topic({
            ros : ros,
            name : '/system_shell/cmd_string',
            messageType : 'std_msgs/String'
        });
        
        var string = new ROSLIB.Message({
            data : 'navigation', 
        });
        
        function cancel() {
        	string.data = 'cancel';
        	cmd_string.publish(string);
        }
        
        var mode="navigation";
        function change_mode(){
        	if(mode=="navigation"){
        		string.data = "gmapping";
        	}
        	else if(mode=="gmapping"){
        		string.data = "navigation";
        	}
        	cmd_string.publish(string);
        }
        function change_mode_text(){
        	if(mode=="navigation"){
        		//document.getElementById("mode_image")
        		document.getElementById("mode_text").innerHTML = "导航模式";
        	}
        	else if(mode=="gmapping"){
        		document.getElementById("mode_text").innerHTML = "建图模式";
        	}
        }
        
        var action = "goal";
        function change_action(){
        	if (action == "goal"){
        		action = "pose";
        		document.getElementById("action_text").innerHTML = "位置估计";
        	}
        	else if (action == "pose"){
        		action = "goal";
                document.getElementById("action_text").innerHTML = "目标地点";
        	}
        }
        
        function save_map(){
        	string.data = 'gmapping_pose';
        	cmd_string.publish(string);
        	string.data = 'save_map';
        	cmd_string.publish(string);
           	string.data = 'save_map_edit';
           	cmd_string.publish(string);
        }
</script>

    <style type="text/css">
        ul {
            position: absolute;
            top: 0;
            right: 50px;
            width: 100px;
        }

        li {
            float: left;
            width: 100%;
            list-style: none;
            height: 175px;
        }

            li a {
                font-size: 1.5em;
                width: 100px;
            }
    </style>
</head> 

<body onload="init()" style="margin: 0; border: solid 0px #f00;">
    <div id="nav"></div>
    <div id="menu">
        <ul>
            <li onclick="cancel()">
                <img src="images/set_map.png" style="width: 100%" />
                <a>停止运动</a>
            </li>
            <li onclick="change_mode()">
                <img id="mode_image" src="images/set_map.png" style="width: 100%" />
                <a id="mode_text">导航模式</a>
            </li>
            <li onclick="change_action()">
                <img src="images/set_map.png" style="width: 100%" />
                <a id="action_text" style="text-align: center">目标地点</a>
            </li>
            <li onclick="save_map()">
                <img src="images/set_map.png" style="width: 100%" />
                <a>保存地图</a>
            </li>
            <li>
                <img src="images/set_map.png" style="width: 100%" />
                <a href="teleop.html">控制圆盘</a>
            </li>
        </ul>

    </div>
</body>
</html>
