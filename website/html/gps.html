<!DOCTYPE html>
<html>
    <head>
        <title>H5地理位置Demo</title>
        <script src="http://api.map.baidu.com/api?v=1.3" type="text/javascript">
        </script>
            <script type="text/javascript" src="js/convertor.js">
      
        </script>
        <script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
    </head>
    <body>
        <div id="map" style="width:600px; height:400px">
        </div>
        <button style="width:100px;height:100px" onclick="getPos()">获取当前位置</button>
    </body>
    <script type="text/javascript">

        function getPos() {

            if (window.navigator.geolocation) {
                var options = {
                    enableHighAccuracy: false,
                };
                window.navigator.geolocation.getCurrentPosition(handleSuccess, handleError, options);
            } else {
                alert("浏览器不支持html5来获取地理位置信息");
            }

            function handleSuccess(position) {
                // 获取到当前位置经纬度  本例中是chrome浏览器取到的是google地图中的经纬度
                var lng = position.coords.longitude;
                var lat = position.coords.latitude;
                // 调用百度地图api显示
                var map = new BMap.Map("map");
                var ggPoint = new BMap.Point(lng, lat);
                // 将google地图中的经纬度转化为百度地图的经纬度
                BMap.Convertor.translate(ggPoint, 2, function (point) {
                    var marker = new BMap.Marker(point);
                    map.addOverlay(marker);
                    map.centerAndZoom(point, 15);
                });

                socket_send(lat, lng);
            }

            function handleError(error) {
                console.log(error);
            }
        }

        var ros = new ROSLIB.Ros({
            url: 'ws://192.168.0.111:9090'
        });
        ros.on('connection', function () {
            console.log('Connected to websocket server.');
        });

        ros.on('error', function (error) {
            console.log('Error connecting to websocket server: ', error);
        });

        ros.on('close', function () {
            console.log('Connection to websocket server closed.');
        });

        function socket_send(latitude, longitude)
        {
            var Geolocation = new ROSLIB.Topic({
                ros: ros,
                name: '/Geolocation',
                messageType: '/sensor_msgs/NavSatFix'
            });

            var GPS = new ROSLIB.Message({
                header: {
                    frame_id: "GPS"
                },
                latitude: latitude,
                longitude: longitude,
                position_covariance: [0, 0, 0, 0, 0, 0, 0, 0, 0]
            });
            Geolocation.publish(GPS);
        }
    </script>
</html>
