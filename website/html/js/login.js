/*! tailinserver 2017-02-22 */
var DbEvent=DbEvent||{REVISION:"0.0.6.0-2016-12.23",State:{LoginSuccess:0,LoginFail_NotExist:-1,LoginFail_LoginedIn:-2,LoginFail_WrongPwd:-3,RegisterSuccess:1,RegisterFail:-4,RegisterFail_Exist:-5,RegisterFail_InvalidCode:-6,LogoutSuccess:2,LogoutFail:-7,UpdataSuccess:3,UpdataFail:-8,GenerateCodeSuccess:4,GenerateCodeFail:-9,InvalidAuthCode:-10,RegisterFail_CodeOutOfDate:-11,UpdateAuthSuccess:5,UpdateAuthFail:-12,UpdateAuthFail_Denied:-13,StoreOpRecordSuccess:6,StoreOpRecordFail:-14,QueryOpRecordSuccess:7,QueryOpRecordFail:-15},ID:{login_name:"#login-name",login_password:"#login-password",register_name:"#register-name",register_password:"#register-password",register_password_agin:"#register-password-agin",register_auth_code:"#register-auth-code",old_password:"#old-password",new_password:"#new-password",confirm_password:"#confirm-password",user_table:"#hty-user-table",history_table:"#hty-history-table"},StoreRecord:function(a,b){var c="http://"+window.location.hostname+":8808/store_record";$.ajax({type:"post",url:c,data:{time:this.formatDate(new Date,"yyyy-M-d hh:mm:ss"),username:a,operation:b},async:!0,success:function(a){console.log(a)},dataType:"json"})},isPasswd:function(a){var b=/^(\w){6,20}$/;return!!b.exec(a)},isRegisterUserName:function(a){var b=/^[a-zA-Z]{1}([a-zA-Z0-9]|[._]){4,19}$/;return!!b.exec(a)},AddtableList:function(a,b){$(b)[0].innerHTML="";var c="",d=new Array;for(var e in a[0])c+="<th data-priority='1'>"+e+"</th>",d.push(e);var f=" <thead><tr>"+c+"</tr></thead>";$(b).append(f);for(var g="",h=0;h<a.length;h++){for(var i="",j=0;j<d.length;j++)i+="<td>"+a[h][d[j]]+"</td>";g+="<tr>"+i+"</tr>"}var k="<tbody>"+g+"</tbody>";$(b).append(k)},formatDate:function(a,b){var c=function(a){return a+="",a.replace(/^(\d)$/,"0$1")},d={yyyy:a.getFullYear(),yy:a.getFullYear().toString().substring(2),M:a.getMonth()+1,MM:c(a.getMonth()+1),d:a.getDate(),dd:c(a.getDate()),hh:a.getHours(),mm:a.getMinutes(),ss:a.getSeconds()};return b||(b="yyyy-MM-dd hh:mm:ss"),b.replace(/([a-z])(\1)*/gi,function(a){return d[a]})},formatCSTDate:function(a,b){return formatDate(new Date(a),b)}};$(function(){$("#login").click(function(){var a=$(DbEvent.ID.login_name)[0].value,b=$(DbEvent.ID.login_password)[0].value,c="http://"+window.location.hostname+":8808/login";$.ajax({type:"post",url:c,data:{username:a,password:b},async:!0,success:function(c){console.log(c),c.status==DbEvent.State.LoginSuccess?(TL.LoginName=a,TL.LoginPassword=b,TL.Auth=c.auth,$(".current-user").html(c.auth),$.mobile.changePage("#hrg-navigation-main-page",{transition:"slide"}),DbEvent.StoreRecord(a,JSON.stringify({action:"login"}))):c.status==DbEvent.State.LoginFail_NotExist?sweetAlert("用户名不存在","","error"):c.status==DbEvent.State.LoginFail_LoginedIn?sweetAlert("该用户已在其他设备登录","","warning"):c.status==DbEvent.State.LoginFail_WrongPwd&&sweetAlert("密码错误","","error")},dataType:"json"})}),$("#logout").click(function(){var a=TL.LoginName,b="http://"+window.location.hostname+":8808/logout";$.ajax({type:"post",url:b,data:{username:a},async:!0,success:function(a){console.log(a),a.status==DbEvent.State.LogoutSuccess?(TL.LoginName="",TL.LoginPassword="",TL.Auth="",$(DbEvent.ID.login_name)[0].value="",$(DbEvent.ID.login_password)[0].value="",$.mobile.changePage("#hrg-login-page",{transition:"slide"})):a.status==DbEvent.State.LogoutFail&&sweetAlert("注销失败","","error")},dataType:"json"})}),$("#get").click(function(){var a="http://"+window.location.hostname+":8808/user_select";$.ajax({type:"get",url:a,async:!0,success:function(a){console.log(a),DbEvent.AddtableList(a,DbEvent.ID.user_table),$.mobile.changePage("#hty-user-table-page",{transition:"slide"})},dataType:"json"})}),$("#btn-register").click(function(){var a=$(DbEvent.ID.register_name)[0].value,b=$(DbEvent.ID.register_password)[0].value,c=$(DbEvent.ID.register_auth_code)[0].value;if(!DbEvent.isRegisterUserName(a))return void sweetAlert("用户名不合法","","warning");if(""==c)return void sweetAlert("授权码不能为空","","warning");if("hitrobot"!=c&&32!=c.length)return void sweetAlert("授权码不合法","","warning");if(!DbEvent.isPasswd(b))return void sweetAlert("密码不合法","","warning");if(b!=$(DbEvent.ID.register_password_agin)[0].value)return void sweetAlert("密码不一致","","error");var d="http://"+window.location.hostname+":8808/register";$.ajax({type:"post",url:d,data:{username:a,password:b,authCode:c},async:!0,success:function(a){a.status==DbEvent.State.RegisterSuccess?$.mobile.changePage("#hrg-login-page",{transition:"slide"}):a.status==DbEvent.State.RegisterFail?sweetAlert("注册失败","","error"):a.status==DbEvent.State.RegisterFail_Exist&&sweetAlert("注册失败 用户名已存在","","error")},dataType:"json"})}),$("#btn-change-login-password").click(function(){if($(DbEvent.ID.old_password)[0].value!=TL.LoginPassword)return void sweetAlert("原密码输入错误","","error");if(!DbEvent.isPasswd($(DbEvent.ID.new_password)[0].value))return void sweetAlert("新密码不合法","","warning");if($("#new-password")[0].value!=$(DbEvent.ID.confirm_password)[0].value)return void sweetAlert("输入密码不一致","","error");var a=TL.LoginName,b=$(DbEvent.ID.new_password)[0].value,c="http://"+window.location.hostname+":8808/update";$.ajax({type:"post",url:c,data:{username:a,password:b},async:!0,success:function(a){console.log(a),a.status==DbEvent.State.UpdataSuccess?(TL.LoginPassword=b,sweetAlert("修改成功","","success"),$("#hrg-change-password-popup").popup("close")):a.status==DbEvent.State.UpdataFail&&sweetAlert("修改失败","","error")},dataType:"json"})}),$("#btn-get-auth-code").click(function(){$(this).buttonMarkup({icon:"hrg-load"});var a=TL.LoginName,b=$("#auth-code-select").val(),c="http://"+window.location.hostname+":8808/code";$.ajax({type:"post",url:c,data:{username:a,auth:b},async:!0,success:function(a){console.log(a),$("#btn-get-auth-code").buttonMarkup({icon:"star"}),a.status==DbEvent.State.GenerateCodeSuccess?$("#new-auth-code").val(a.authcode):a.status==DbEvent.State.GenerateCodeFail&&sweetAlert(a.message,"","error")},dataType:"json"})}),$("#hty-history-search-page").live("pageshow",function(a,b){if("hty-user-manger-page"==b.prevPage[0].id){var c="http://"+window.location.hostname+":8808/get_users",d="<option value='-1'>ALL</option>";$.ajax({type:"get",url:c,async:!0,success:function(a){console.log(a);for(var b=0;b<a.users.length;b++)d+="<option value='"+a.users[b]+"'>"+a.users[b]+"</option>";$("#hty-users-list").append(d),$("#hty-users-list").selectmenu(),$("#hty-users-list").selectmenu("refresh")},dataType:"json"})}}),$("#hty-history-search-page").live("pagehide",function(a,b){"hrg-user-manger-page"==b.toPage[0].id&&($("#hty-users-list")[0].innerHTML="")}),$("#btn-history-search").click(function(){var a=$("#dtl")[0].value,b=$("#dt2")[0].value,c=$("#hty-users-list").find("option:selected").text();a=a.replace("T"," "),b=b.replace("T"," ");var d="http://"+window.location.hostname+":8808/query_op";$.ajax({type:"post",url:d,data:{username:c,start:a,end:b},async:!0,success:function(a){a.status==DbEvent.State.QueryOpRecordSuccess&&(DbEvent.AddtableList(a.records,DbEvent.ID.history_table),$.mobile.changePage("#hty-history-page",{transition:"slide"}))},dataType:"json"})})});